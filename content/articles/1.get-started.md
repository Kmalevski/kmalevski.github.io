---
cover: /articles/article-1/malware-cover.jpg
author:
  name: Konstantin Malevski
date: 2024-05-22T00:00:00.000Z
layout: article
---

# First internship 
Malware analysis project

Check out Outflank here and reserve a meeting :(https://www.outflank.nl/)
![Outflank logo](/articles/article-1/outflank1.png)

### Table of Contents
1.  [Introduction]
2.  [Installation and configuration]
3.  [Integration of tools with Python]
    - [PeSieve]
    - [Moneta]
4. [Parsing the result's JSON file]
5. 


## Introduction
The main objective of my internship was to build an isolated lab capable of systematically validating malware payloads. This lab would ensure that payloads behave as expected and identify indicators of compromise (IOCs) 

Firstly I conducted research on the available solutions on the Internet. 
I compared them and chose the best fit for the project.

You can check their respective repos below:

Cuckoo Sandbox: (https://github.com/cuckoosandbox/cuckoo)
![Cuckoo](/articles/article-1/cuckoo.png)

Drakvuf: (https://github.com/tklengyel/drakvuf)
![Drakvuf](/articles/article-1/drakvuf.png)

![CapeV2 repository](/articles/article-1/CAPEv2.png)


After comparing eachother I have decided to select CAPEv2 because it is better all round than Drakvuf, 
it is a continuation of Cuckoo, and has its own features.

## Installation and configuration
Setting up CapeV2 required configuring a secure environment using isolated virtual machines. 

This setup ensured that the analysis of potentially harmful payloads would not affect the host system. 

The process involved installing dependencies, configuring network settings, and setting up Windows analysis machines.

![Architecture CapeV2](/articles/article-1/capearchitecture.png)
> CapeV2 architecture shows the interaction between host and guest machines

I successfully installed and configured CapeV2 in a Linux environment. This involved addressing various technical challenges and troubleshooting issues to ensure a stable setup. 
The sandboxing solution is known for its complex setup and it delivered on that part XD.

> Issue during running the installation script for all dependencies
![Architecture CapeV2](/articles/article-1/issue1.png)


> Virtualization module not enabled in Ubuntu resulting in freezing the virtual machine
![Architecture CapeV2](/articles/article-1/issue2.png)

> Dashboard of sandbox
![Dashboard cape](/articles/article-1/dashboard.png)

 
## Integration of tools using Python
Tools implemented:
- Pe-sieve
- Moneta 

A significant part of my internship was integrating tools like PE-Sieve and Moneta into CapeV2. PE-Sieve and Moneta help detecting in-memory modifications, which is essential for the payload validation process. I added them for an extra layer of scanning.

I used Python to write scripts that ran the tools as an auxiliary module and became part of CAPEv2's system.
That way I can retrieve the results from the tools that run on the PE file.

![pesieve_output](/articles/article-1/pesieveOutput.png)

![moneta_output](/articles/article-1/moneta.png)

![retrieved_files](/articles/article-1/results.png)

## Parsing the result's JSON file
I developed a Flask application to parse and display data from PE-Sieve's JSON reports. This application transformed raw data into a more readable format, making it easier for analysts and operators to interpret the results.

![JSON parser](/articles/article-1/parsers.png)




## Reflection
My six-month journey at Outflank was both challenging and rewarding. From going through the complex setup of CapeV2 to integrating advanced tools for malware analysis, every step was a learning curve. I hope to continue exploring and contributing to the field of cybersecurity. 

I have shared my findings with the CAPEv2 community in their Github repository.

## Results
- Research on available sandboxing solutions
    > Extensively researched various sandboxing solutions to identify the one best suited for the project. 
- Provided guide on installation and configuration of CAPEv2
    > Installed and configured CapeV2 in a Linux environment, addressing various technical challenges and troubleshooting issues.
- Integration of PeSieve and Moneta tools for checking modified PE files
    > I have successfully added those 2 tools for scanning memory modifications in CAPEv2
- Hypothesis testing
    > Implemented a method/process for validating specific hypotheses about malware behavior using the integrated tools.



### Additional resources
If you want to read more about my research and findings click the links below:

Document 1: (https://docs.google.com/document/d/1D4KcmOjHAVkuApVuXmvaG8e39ci4o1W2-LJkrHW9Kbg/edit?usp=sharing)

Document 2: (https://docs.google.com/document/d/16ljtHHjs8Ykw86qGVeSWeJnc0pqLZHA10ZUEeeE5b6w/edit?usp=sharing)






Stay tuned for more newsðŸ””!
K@sio out.... 